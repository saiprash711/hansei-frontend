<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hansei - Enhanced Sales Intelligence Dashboard</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://daikin-n9wy.onrender.com http://localhost:3000; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://storage.googleapis.com data:;">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- HONEYPOT STYLE: Hides the bot trap field --- */
        .honey_pot_field {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            height: 0;
            width: 0;
            z-index: -1;
        }
        /* Custom Styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }

        /* --- Custom Animated Background --- */
        #main-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            overflow: hidden;
            z-index: -1;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--color1), var(--color2));
            animation: move 20s infinite ease-in-out;
            opacity: 0.5;
        }

        .bg-circle:nth-child(1) {
            width: 400px;
            height: 400px;
            top: 10%;
            left: 10%;
            --color1: rgba(79, 70, 229, 0.4); /* Indigo 600 */
            --color2: rgba(79, 70, 229, 0);
            animation-duration: 25s;
        }

        .bg-circle:nth-child(2) {
            width: 500px;
            height: 500px;
            bottom: 5%;
            right: 15%;
            --color1: rgba(147, 51, 234, 0.4); /* Purple 600 */
            --color2: rgba(147, 51, 234, 0);
            animation-duration: 30s;
            animation-delay: -5s;
        }
        
        .bg-circle:nth-child(3) {
            width: 300px;
            height: 300px;
            top: 20%;
            right: 5%;
            --color1: rgba(219, 39, 119, 0.3); /* Pink 600 */
            --color2: rgba(219, 39, 119, 0);
            animation-duration: 20s;
            animation-delay: -10s;
        }

        @keyframes move {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -60px) scale(1.1); }
            50% { transform: translate(-20px, 30px) scale(0.9); }
            75% { transform: translate(-50px, -40px) scale(1.05); }
        }

        /* --- Screen Transitions --- */
        .screen {
            display: none;
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        #loginScreen {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- Staggered Animation for Cards --- */
        .kpi-card, .chart-card, .summary-card, .analytics-card, .decision-card {
            opacity: 0;
            transform: translateY(20px);
            animation: slideUpFadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUpFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Chart.js Custom Tooltip --- */
        .chartjs-tooltip {
            background: rgba(15, 23, 42, 0.8) !important;
            backdrop-filter: blur(5px);
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        
        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
        
        /* --- Custom Badges & Highlights --- */
        .model-inverter { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .model-non-inverter { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-optimal { background-color: #16a34a; }
        .status-good { background-color: #2563eb; }
        .status-excess { background-color: #f97316; }
        .status-critical { background-color: #dc2626; }
        .highlight-col { font-weight: 700; color: white; border-radius: 8px; padding: 5px 10px; }
        .highlight-red { background-color: #dc2626; }
        .highlight-orange { background-color: #f97316; }

        /* --- Chatbot Styles --- */
        #chatbot-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        #chatbot-toggle {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        #chatbot-toggle:hover {
            background-color: #6366f1; /* Indigo 500 */
            transform: scale(1.1);
        }
        #chatbot-window {
            display: none;
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: rgba(15, 23, 42, 0.8); /* Slate 900 with transparency */
            backdrop-filter: blur(10px);
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            flex-direction: column;
            overflow: hidden;
            transform-origin: bottom right;
            animation: pop-in 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        #chatbot-header {
            padding: 1rem;
            background: rgba(30, 41, 59, 0.5); /* Slate 800 with transparency */
            border-bottom: 1px solid #334155;
        }
        #chatbot-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.5;
        }
        .user-message {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot-message {
            background-color: #374151; /* Gray 700 */
            color: #d1d5db; /* Gray 300 */
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        #chatbot-input-container {
            padding: 1rem;
            border-top: 1px solid #334155;
            display: flex;
            gap: 0.5rem;
        }
        #chatbot-input {
            flex-grow: 1;
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 0.75rem;
            color: white;
            outline: none;
        }
        #chatbot-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        #chatbot-send {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 1rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* --- New Analytics Tab Styles --- */
        .analytics-sub-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 0.75rem;
        }
        .analytics-sub-nav-item {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .analytics-sub-nav-item.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3), 0 2px 4px -1px rgba(79, 70, 229, 0.2);
        }
        .analytics-page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .decision-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5), rgba(15, 23, 42, 0.5));
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .decision-card h4 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #c7d2fe; /* Indigo 200 */
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .decision-card p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #cbd5e1; /* Slate 300 */
        }
        .decision-card .data-point {
            font-weight: 600;
            color: #f8fafc; /* Slate 50 */
        }
        
        /* ADDED: Loading and Error State Styles */
        .placeholder-loading {
            background-color: rgba(51, 65, 85, 0.5);
            border-radius: 0.75rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        .component-error {
            background-color: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: #f87171; /* Red 400 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }

        /* ADDED: Connection status indicator */
        .connection-status {
            position: fixed;
            top: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .connection-status.connected {
            background-color: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }
        .connection-status.disconnected {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        .connection-status.connecting {
            background-color: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

    </style>
    <script>
        // Basic deterrents (easily bypassed, but better than nothing)
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) { // F12
                return false;
            }
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U
                return false;
            }
        };
    </script>
</head>
<body class="text-slate-300">

    <div id="connectionStatus" class="connection-status connecting">
        <span id="connectionText">Connecting...</span>
    </div>

    <div id="main-bg">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <div id="loginScreen" class="screen min-h-screen w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-900/50 backdrop-blur-xl border border-slate-700 rounded-2xl p-8 shadow-2xl shadow-indigo-500/10">
            <div class="text-center mb-8">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAC0CAYAAAD32+3IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAA3NCSVQICAjb4U/gAAAIlklEQVR4nO3d34tdRRjA8VfSlLSLpLgIuuhCF258gS4q6opgQ3BRRBAR3PgD3LgQUdCFIC7cqKhbFxEE3QR3FkHwD+xDCFGKjYhNbR7O/M5759yZSU5ycnLvnN8Xgsy8N/u9d9/MvDPJSSGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEE" alt="Hansei Consultancy Logo" class="mx-auto mb-4 w-48">
                <h1 class="text-3xl font-bold text-white">Hansei Intelligence Portal</h1>
                <p class="text-slate-400 mt-2">Securely access your sales analytics dashboard.</p>
            </div>
            <div id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-300 mb-2">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter your username" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-300 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" placeholder="Enter your password" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300">
                        <button type="button" class="absolute inset-y-0 right-0 flex items-center px-4 text-slate-500 hover:text-indigo-400" onclick="togglePassword()"><svg id="eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg><svg id="eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274 4.057 5.064-7 9.542-7 .847 0 1.673.124 2.458.35M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20"></path></svg></button>
                    </div>
                </div>
                
                <div class="honey_pot_field">
                    <label for="honey_pot">Do not fill this field</label>
                    <input type="text" id="honey_pot" name="honey_pot" tabindex="-1" autocomplete="off">
                </div>
                
                <button type="button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500 transition-all duration-300 transform hover:scale-105" onclick="doLogin()">Secure Login</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="screen"><div class="flex h-screen bg-slate-900/80">
        <nav class="w-64 bg-slate-900/70 backdrop-blur-lg border-r border-slate-800 flex flex-col">
            <div class="flex items-center justify-center px-6 h-20 border-b border-slate-800">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAC0CAYAAAD32+3IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAA3NCSVQICAjb4U/gAAAIlklEQVR4nO3d34tdRRjA8VfSlLSLpLgIuuhCF258gS4q6opgQ3BRRBAR3PgD3LgQUdCFIC7cqKhbFxEE3QR3FkHwD+xDCFGKjYhNbR7O/M5759yZSU5ycnLvnN8Xgsy8N/u9d9/MvDPJSSGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEE" alt="Hansei Consultancy Logo" class="w-32">
            </div>

            <div class="flex-grow p-4 space-y-2">
                <a href="#" class="nav-item active" data-screen="dashboard"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span>South Region</span></a>
                <a href="#" class="nav-item" data-screen="billingVelocity"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Billing Velocity</span></a>
                <a href="#" class="nav-item" data-screen="coverage"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>South Coverage</span></a>
                <a href="#" class="nav-item" data-screen="models"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 0v11a2 2 0 002 2h5a2 2 0 002-2V5a2 2 0 00-2-2H7z"></path></svg><span>Product Analytics</span></a>
                <a href="#" class="nav-item" data-screen="planning"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span>Planning</span></a>
                <a href="#" class="nav-item" data-screen="analytics"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Hansei Analytics</span></a>
                <a href="#" id="dataUploadNav" class="nav-item" data-screen="dataUpload" style="display: none;">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>Data Upload</span>
                </a>
            </div>
            <div class="p-4 mt-auto">
                <div class="p-4 bg-slate-800/50 border border-slate-700 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </div>
                            <div>
                                <p id="userDisplayName" class="font-semibold text-white">Smart User</p>
                                <p id="authStatus" class="text-xs text-green-400">Authenticated</p>
                            </div>
                        </div>
                    </div>
                    <button class="w-full mt-4 flex items-center justify-center gap-2 bg-slate-700 hover:bg-red-600/50 text-slate-300 hover:text-red-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-300" onclick="secureLogout()"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span>Logout</span></button>
                </div>
            </div>
        </nav>
        <main class="flex-1 overflow-y-auto">
            <div id="dashboardContent" class="app-content p-8">
                <h2 class="text-3xl font-bold text-white mb-2">South Region Dashboard</h2>
                <p id="currentSelection" class="text-slate-400 mb-8">Availability Situation For: South Region (All Models, All Technologies)</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="kpiGrid"></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2"><div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><div class="flex justify-between items-center mb-4"><div><h3 class="text-xl font-bold text-white">Branch Performance</h3><p class="text-sm text-slate-400">Click a branch to see its detailed performance.</p></div><button id="resetViewBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors" onclick="displayCityView('South Region')">Region View</button></div><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4" id="heatmapGrid"></div></div></div>
                    <div class="lg:col-span-1"><div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 h-full"><h3 class="text-xl font-bold text-white mb-2">Critical Alerts</h3><p class="text-sm text-slate-400 mb-4">Hansei AI Recommendations</p><div class="space-y-3" id="alertsPanel"></div></div></div>
                </div>
                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mt-6"><h3 class="text-xl font-bold text-white mb-2">Comprehensive Product Matrix</h3><p class="text-sm text-slate-400 mb-4" id="tableSubtitle">Real-time supply chain data with weekly plans and stock analysis</p><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-400"><thead class="text-xs text-slate-300 uppercase bg-slate-800"><tr><th scope="col" class="px-4 py-3">Product</th><th scope="col" class="px-4 py-3 text-center">Op. Stock</th><th scope="col" class="px-4 py-3 text-center">Avl. Stock</th><th scope="col" class="px-4 py-3 text-center">Transit</th><th scope="col" class="px-4 py-3 text-center">Billing</th><th scope="col" class="px-4 py-3 text-center">Month Plan</th><th scope="col" class="px-4 py-3 text-center">Avail %</th><th scope="col" class="px-4 py-3 text-center">Status</th></tr></thead><tbody id="productTableBody"></tbody><tfoot class="font-semibold text-white bg-slate-800"><tr class="border-t-2 border-slate-700"><th scope="row" id="totalTitle" class="px-4 py-3 text-base">South Region Total</th><td class="px-4 py-3 text-center" id="totalOpStock">-</td><td class="px-4 py-3 text-center" id="totalStock">-</td><td class="px-4 py-3 text-center" id="totalTransit">-</td><td class="px-4 py-3 text-center" id="totalBilling">-</td><td class="px-4 py-3 text-center" id="totalMonthPlan">-</td><td class="px-4 py-3 text-center" id="avgAvailability">-</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs rounded-full bg-green-500 text-white">ACTIVE</span></td></tr></tfoot></table></div></div>
                
                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mt-6">
                    <h3 id="summaryTableTitle" class="text-xl font-bold text-white mb-4">Detailed Stock & Planning Summary</h3>
                    <div id="summaryKpiGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                        </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                                <tr>
                                    <th class="px-2 py-2">Material</th>
                                    <th class="px-2 py-2 text-center">Op. Stk</th>
                                    <th class="px-2 py-2 text-center">Plan</th>
                                    <th class="px-2 py-2 text-center">Avl. Stk</th>
                                    <th class="px-2 py-2 text-center">Transit</th>
                                    <th class="px-2 py-2 text-center">Billing</th>
                                    <th class="px-2 py-2 text-center">Total Avl.</th>
                                    <th class="px-2 py-2 text-center">Bal Dispatch</th>
                                    <th class="px-2 py-2 text-center">Bal Produce</th>
                                    <th class="px-2 py-2 text-center">Excess</th>
                                    <th class="px-2 py-2 text-center">Avl% Plan</th>
                                </tr>
                            </thead>
                            <tbody id="southRegionSummaryTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="billingVelocityContent" class="app-content p-8" style="display: none;">
                <h2 class="text-3xl font-bold text-white mb-6">Billing Velocity Analysis</h2>
                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">Branch Billing Velocity Breakdown</h3>
                    <p class="text-sm text-slate-400 mb-4">Analysis of sales billing speed against the monthly plan for each branch.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                                <tr>
                                    <th class="px-2 py-2">Branch</th>
                                    <th class="px-2 py-2 text-center">Month Plan</th>
                                    <th class="px-2 py-2 text-center">Billing</th>
                                    <th class="px-2 py-2 text-center">Balance to Bill</th>
                                    <th class="px-2 py-2 text-center">Billing Velocity (%)</th>
                                    <th class="px-2 py-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="billingVelocityTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="coverageContent" class="app-content p-8" style="display: none;">
                <h2 class="text-3xl font-bold text-white mb-8">South Coverage Analysis</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 text-center"><p class="text-sm text-slate-400">Total Branches</p><p class="text-3xl font-bold text-white">5</p></div>
                    <div class="summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 text-center"><p class="text-sm text-slate-400">Total Sales Volume</p><p id="southTotalSales" class="text-3xl font-bold text-white">-</p></div>
                    <div class="summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 text-center"><p class="text-sm text-slate-400">Avg. Penetration</p><p id="southAvgPenetration" class="text-3xl font-bold text-white">-</p></div>
                    <div class="summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 text-center"><p class="text-sm text-slate-400">Top Performer</p><p id="southTopPerformer" class="text-3xl font-bold text-white">-</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">Branch Sales Contribution</h3><div class="relative h-72"><canvas id="southCoverageChart"></canvas></div></div>
                    <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">City Performance Snapshot</h3><div class="relative h-72"><canvas id="southPenetrationChart"></canvas></div></div>
                </div>
            </div>

            <div id="modelsContent" class="app-content p-8" style="display: none;">
                <div id="models-analytics-container">
                    <h2 class="text-3xl font-bold text-white mb-8">Product Analytics Deep Dive</h2>
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div><label for="starSelect" class="block text-sm font-medium text-slate-300 mb-2">Star Rating</label><select id="starSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                        <div><label for="technologySelect" class="block text-sm font-medium text-slate-300 mb-2">Technology</label><select id="technologySelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                        <div><label for="tonnageSelect" class="block text-sm font-medium text-slate-300 mb-2">Tonnage</label><select id="tonnageSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                        <button class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg" onclick="exportModelsData()">Export Data</button>
                    </div>
                    <div id="modelsKpiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Tonnage</h3><div id="tonnageChartContainer" class="relative h-72"><canvas id="tonnageChart"></canvas></div></div>
                                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Star Rating</h3><div id="starRatingChartContainer" class="relative h-72"><canvas id="starRatingChart"></canvas></div></div>
                            </div>
                            <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mt-6"><h3 class="text-xl font-bold text-white mb-4">Top 10 Products (by Sales Qty.)</h3><div id="topModelsChartContainer" class="relative h-80"><canvas id="topModelsChart"></canvas></div></div>
                        </div>
                        <div class="lg:col-span-2">
                             <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Technology</h3><div id="technologyChartContainer" class="relative h-48"><canvas id="technologyChart"></canvas></div></div>
                             <div class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 h-auto">
                                <h3 class="text-xl font-bold text-white mb-4">Dynamic Insights</h3>
                                <div id="modelInsightsContainer">
                                    <ul id="modelInsightsList" class="space-y-4 text-sm"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="planningContent" class="app-content p-8" style="display: none;">
                <h2 class="text-3xl font-bold text-white mb-6">Planning & Execution Analysis</h2>
                <div id="planningNarrative" class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-8">
                    </div>
                <h3 class="text-2xl font-bold text-white mb-4">Recommended Planning Actions</h3>
                <div id="planningDecisions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    </div>
                <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4">Branch Plan vs. Actuals Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-800">
                                <tr>
                                    <th class="px-2 py-2">Branch</th><th class="px-2 py-2 text-center">Op. Stock</th><th class="px-2 py-2 text-center">Plan</th>
                                    <th class="px-2 py-2 text-center">Avl. Stock</th><th class="px-2 py-2 text-center">Transit</th><th class="px-2 py-2 text-center">Billing</th>
                                    <th class="px-2 py-2 text-center">Bal to Bill</th><th class="px-2 py-2 text-center">Availability</th><th class="px-2 py-2 text-center">Bal to Dispatch</th>
                                    <th class="px-2 py-2 text-center">Excess</th><th class="px-2 py-2 text-center">Billing Velocity</th>
                                </tr>
                            </thead>
                            <tbody id="branchPlanningTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="analyticsContent" class="app-content p-8" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Hansei Analytics Hub</h2>
                </div>

                <div id="analyticsSubNav" class="analytics-sub-nav">
                    <div class="analytics-sub-nav-item active" data-page="overview">Executive Overview & Decisions</div>
                    <div class="analytics-sub-nav-item" data-page="deepdive">Data Deep Dive</div>
                    <div class="analytics-sub-nav-item" data-page="trends">Performance Trends</div>
                </div>

                <div id="analyticsPage-overview" class="analytics-page" style="display: block;">
                    <div class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-8">
                        <h3 class="text-xl font-bold text-white mb-3">South Region Performance Summary</h3>
                        <p id="executiveSummaryNarrative" class="text-slate-300 leading-relaxed"></p>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-white mb-4">Key Business Decisions Recommended by Hansei</h3>
                    <div id="actionableDecisions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        </div>
                    
                    <div id="analyticsKpiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        </div>
                </div>

                <div id="analyticsPage-deepdive" class="analytics-page">
                     <div id="deepDiveNarrative" class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-8">
                        </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Top 10 Performing Models (by Sales)</h3>
                            <div class="overflow-y-auto h-96">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-300 uppercase bg-slate-800 sticky top-0">
                                        <tr><th scope="col" class="px-4 py-2">Model</th><th scope="col" class="px-4 py-2 text-center">Sales (Units)</th><th scope="col" class="px-4 py-2 text-center">Plan Achieve %</th></tr>
                                    </thead>
                                    <tbody id="top10ModelsBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Bottom 10 Performing Models (by Sales)</h3>
                            <div class="overflow-y-auto h-96">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="text-xs text-slate-300 uppercase bg-slate-800 sticky top-0">
                                        <tr><th scope="col" class="px-4 py-2">Model</th><th scope="col" class="px-4 py-2 text-center">Sales (Units)</th><th scope="col" class="px-4 py-2 text-center">Plan Achieve %</th></tr>
                                    </thead>
                                    <tbody id="bottom10ModelsBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Sales vs. Plan by Branch</h3>
                            <div class="relative h-96"><canvas id="regionalSalesVsPlanChart"></canvas></div>
                        </div>
                        <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Stock vs. Transit by Branch</h3>
                            <div class="relative h-96"><canvas id="regionalStockVsTransitChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="analyticsPage-trends" class="analytics-page">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Monthly Performance Trend (Simulated)</h3>
                            <div class="relative h-[450px]"><canvas id="monthlyTrendsChart"></canvas></div>
                        </div>
                        <div id="trendsNarrative" class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                             </div>
                    </div>
                </div>
            </div>
            
            <div id="dataUploadContent" class="app-content p-8" style="display: none;">
                <h2 class="text-3xl font-bold text-white mb-8">Backend Data Processing</h2>
                <div class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-8 max-w-2xl mx-auto">
                    <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-xl p-12 text-center cursor-pointer hover:border-indigo-500 hover:bg-slate-800 transition-colors duration-300">
                        <svg class="mx-auto h-12 w-12 text-slate-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <p class="mt-4 text-slate-400"><span class="font-semibold text-indigo-400">Upload a file</span> or drag and drop</p>
                        <p class="text-xs text-slate-500">XLSX, CSV up to 50MB</p>
                        <input type="file" id="fileUploadInput" class="hidden" accept=".xlsx, .xls, .csv">
                    </div>
                    <div id="file-upload-filename" class="mt-4 text-center text-slate-300"></div>
                    <button id="processDataButton" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Upload and Process File</button>
                </div>
            </div>

        </main>
    </div></div>

    <div id="notification" class="fixed top-5 right-5 bg-slate-800 text-white py-3 px-5 rounded-lg shadow-lg border border-slate-700 transform translate-x-[120%] transition-transform duration-500 z-50"></div>

    <div id="chatbot-container">
        <div id="chatbot-window">
            <div id="chatbot-header"><h3 class="text-lg font-bold text-white">Hansei AI Assistant</h3><p class="text-sm text-slate-400">Ask me about the data!</p></div>
            <div id="chatbot-messages"></div>
            <div id="chatbot-input-container"><input type="text" id="chatbot-input" placeholder="Type your question..."><button id="chatbot-send">Send</button></div>
        </div>
        <button id="chatbot-toggle"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
    </div>

    <script>
    // ============================================================================
    // SCRIPT: HANSEI SALES INTELLIGENCE DASHBOARD
    // ============================================================================
    console.log('🔐 Hansei Full-Stack Analytics Platform Loading...');

    // ============================================================================
    // GLOBAL STATE & CONFIG
    // ============================================================================
    
    // --- FINAL FIX: Robust Local Environment Detection ---
    // This logic now correctly identifies when the app is running locally,
    // whether from a server (`localhost`) or directly as a file (`file:///`).
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
    const API_BASE_URL = isLocal ? 'http://localhost:3000/api' : 'https://daikin-n9wy.onrender.com/api';
    console.log(`Environment detected as: ${isLocal ? 'Local' : 'Deployed'}. Connecting to API at: ${API_BASE_URL}`);
    
    let appState = { currentUser: null, isAuthenticated: false };
    let chartInstances = {};
    let filteredProductsForExport = []; // To hold data for export

    // ============================================================================
    // CONNECTION STATUS MANAGEMENT
    // ============================================================================
    function updateConnectionStatus(status, message) {
        const statusEl = document.getElementById('connectionStatus');
        const textEl = document.getElementById('connectionText');
        
        statusEl.className = `connection-status ${status}`;
        textEl.textContent = message;
        
        if (status === 'connected') {
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 300);
            }, 2000);
        } else {
            statusEl.style.display = 'block';
            statusEl.style.opacity = '1';
        }
    }

    // ============================================================================
    // API & UTILITY FUNCTIONS
    // ============================================================================
    async function apiCall(endpoint, options = {}) {
        try {
            const token = localStorage.getItem('token');
            const defaultOptions = { 
                headers: { 'Content-Type': 'application/json' },
                signal: AbortSignal.timeout(30000) // 30 second timeout
            };
            if (token) {
                defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { 
                ...defaultOptions, 
                ...options, 
                headers: { ...defaultOptions.headers, ...options.headers } 
            });
            
            if (response.status === 204) { // No Content
                return null;
            }

            const data = await response.json();

            if (!response.ok) {
                if (response.status === 401) { 
                    secureLogout(); 
                }
                throw new Error(data.error || `API Error: ${response.status} ${response.statusText}`);
            }
            console.log(`✅ API call successful to ${endpoint}:`, data);
            return data;
        } catch (error) { 
            console.error(`API call to ${endpoint} failed:`, error); 
            showNotification(error.message, 'error');
            throw error; 
        }
    }

    function togglePassword() { 
        const p = document.getElementById('password'); const i1 = document.getElementById('eye-open'); const i2 = document.getElementById('eye-closed');
        p.type = p.type === 'password' ? 'text' : 'password';
        i1.classList.toggle('hidden'); i2.classList.toggle('hidden');
    }

    function showNotification(message, type = 'success') { 
        const n = document.getElementById('notification'); 
        n.textContent = message; 
        n.className = `fixed top-5 right-5 py-3 px-5 rounded-lg shadow-lg border text-white transform transition-transform duration-500 z-50 ${type === 'success' ? 'bg-green-600 border-green-700' : 'bg-red-600 border-red-700'}`;
        n.classList.remove('translate-x-[120%]'); 
        setTimeout(() => n.classList.add('translate-x-[120%]'), 4000);
    }
    
    // ============================================================================
    // AUTHENTICATION
    // ============================================================================
    async function doLogin() {
        try {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const honey_pot = document.getElementById('honey_pot').value.trim();

            if (!username || !password) return showNotification('Please enter username and password', 'error');
            
            const body = JSON.stringify({ username, password, honey_pot });

            const data = await apiCall('/auth/login', { method: 'POST', body: body });

            if (data.success) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                appState.currentUser = data.user;
                appState.isAuthenticated = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                showNotification(`Welcome, ${data.user.fullName}!`, 'success');
                updateConnectionStatus('connected', 'Connected');
                initializeDashboard();
            }
        } catch (error) { 
            updateConnectionStatus('disconnected', 'Login Failed');
        }
    }

    async function secureLogout() {
        try { await apiCall('/auth/logout', { method: 'POST' }); } catch (error) { console.error('Logout error:', error); }
        localStorage.clear();
        window.location.reload();
    }

    // ============================================================================
    // DASHBOARD INITIALIZATION & NAVIGATION
    // ============================================================================
    function initializeDashboard() {
        document.getElementById('userDisplayName').textContent = appState.currentUser.fullName;
        document.getElementById('authStatus').textContent = appState.currentUser.role.replace('_', ' ').toUpperCase();
        document.getElementById('dataUploadNav').style.display = appState.currentUser.role === 'smart_user' ? 'flex' : 'none';
        setupNavigation();
        buildDashboardContent(); 
        animateCards();
        initializeChatbot();
        initializeDataUpload();
    }

    function setupNavigation() { 
        document.querySelectorAll('.nav-item').forEach(item => { 
            item.addEventListener('click', async function(e) { 
                e.preventDefault(); 
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active', 'bg-slate-700', 'text-white')); 
                this.classList.add('active', 'bg-slate-700', 'text-white'); 
                document.querySelectorAll('.app-content').forEach(c => c.style.display = 'none'); 
                const screenName = this.getAttribute('data-screen');
                document.getElementById(screenName + 'Content').style.display = 'block'; 
                
                try {
                    switch(screenName) {
                        case 'dashboard': await buildDashboardContent(); break;
                        case 'billingVelocity': await buildBillingVelocityPage(); break;
                        case 'coverage': await buildSouthCoverageView(); break;
                        case 'models': await buildModelsPage(); break;
                        case 'planning': await buildPlanningPage(); break;
                        case 'analytics': await buildAnalyticsSummary(); break;
                        case 'dataUpload': break;
                    }
                    animateCards();
                } catch (error) { 
                    updateConnectionStatus('disconnected', 'Backend Error');
                }
            }); 
        }); 
        document.querySelectorAll('.nav-item').forEach(i => { 
            i.classList.add('flex', 'items-center', 'gap-3', 'px-4', 'py-2.5', 'text-slate-300', 'rounded-lg', 'hover:bg-slate-800', 'hover:text-white', 'transition-colors', 'duration-200'); 
            if (i.classList.contains('active')) i.classList.add('bg-slate-700', 'text-white'); 
        }); 
    }

    function animateCards() { 
        document.querySelectorAll('.kpi-card, .chart-card, .summary-card, .analytics-card, .decision-card').forEach((c, i) => { 
            c.style.animationDelay = `${i * 50}ms`; c.style.opacity = '0'; c.style.animationName = 'slideUpFadeIn'; 
        }); 
    }

    // ============================================================================
    // DATA UPLOAD & BACKEND PROCESSING
    // ============================================================================
    function initializeDataUpload() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileUploadInput');
        const processButton = document.getElementById('processDataButton');
        const fileNameDisplay = document.getElementById('file-upload-filename');
        if (!dropZone) return; 
        
        let selectedFile = null;

        const handleFileSelect = (file) => {
            if (file) {
                selectedFile = file;
                fileNameDisplay.textContent = `Selected file: ${file.name}`;
                processButton.disabled = false;
            } else {
                selectedFile = null;
                fileNameDisplay.textContent = '';
                processButton.disabled = true;
            }
        };

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-slate-800'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-indigo-500', 'bg-slate-800'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-500', 'bg-slate-800');
            if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFileSelect(fileInput.files[0]); });
        
        processButton.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            processButton.textContent = 'Uploading & Processing...';
            processButton.disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                // Use fetch directly for FormData uploads
                const uploadResponse = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData,
                    signal: AbortSignal.timeout(60000) // 60 second timeout for file uploads
                });

                const result = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(result.details || result.error || 'File upload failed.');
                }
                
                showNotification('Data processed successfully! Dashboard is refreshing.', 'success');
                
                // Refresh the current page to show the new data
                const activeNav = document.querySelector('.nav-item.active');
                if (activeNav) {
                    activeNav.click();
                } else {
                    buildDashboardContent();
                }

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                processButton.textContent = 'Upload and Process File';
                handleFileSelect(null);
            }
        });
    }

    // ============================================================================
    // PAGE BUILDERS (BACKEND-DRIVEN)
    // ============================================================================

    // Helper functions for loading and error states
    function setComponentLoading(elementId) {
        const el = document.getElementById(elementId);
        if(el) el.innerHTML = `<div class="placeholder-loading h-full w-full p-8 flex items-center justify-center"><p class="text-slate-400">Loading Data...</p></div>`;
    }

    function setComponentError(elementId, message) {
        const el = document.getElementById(elementId);
        if(el) el.innerHTML = `<div class="component-error"><strong>Error</strong><p>${message}</p></div>`;
    }

    async function buildDashboardContent() { 
        await buildHeatmap(); 
        await displayCityView('South Region'); 
    }
    
    // This function now fetches and displays all data for the selected city/region
    async function displayCityView(cityName) {
        document.getElementById('currentSelection').textContent = `Loading data for ${cityName}...`;
        
        // Set loading states for all components
        setComponentLoading('kpiGrid');
        setComponentLoading('alertsPanel');
        document.getElementById('productTableBody').innerHTML = `<tr><td colspan="8" class="text-center p-8"><div class="placeholder-loading h-24 w-full"></div></td></tr>`;
        setComponentLoading('summaryKpiGrid');
        document.getElementById('southRegionSummaryTableBody').innerHTML = `<tr><td colspan="11" class="text-center p-8"><div class="placeholder-loading h-24 w-full"></div></td></tr>`;

        // Highlight the selected city in the heatmap
        document.querySelectorAll('.heat-cell').forEach(cell => {
            cell.classList.toggle('ring-2', cell.getAttribute('data-city') === cityName);
            cell.classList.toggle('ring-indigo-400', cell.getAttribute('data-city') === cityName);
        });

        // Fetch data sequentially to reduce load and handle errors gracefully
        const inventoryEndpoint = cityName === 'South Region' ? '/sales/inventory/region/South%20Region' : `/sales/inventory/branch/${encodeURIComponent(cityName)}`;
        const kpiEndpoint = cityName === 'South Region' ? '/sales/kpis' : `/sales/kpis?branch=${encodeURIComponent(cityName)}`;
        const summaryEndpoint = cityName === 'South Region' ? '/sales/region-summary' : `/sales/region-summary?branch=${encodeURIComponent(cityName)}`;
        
        document.getElementById('currentSelection').textContent = `Availability Situation For: ${cityName}`;
        document.getElementById('totalTitle').textContent = `${cityName.toUpperCase()} TOTAL`;
        
        try {
            const kpisRes = await apiCall(kpiEndpoint);
            updateKPIsFromAPI(kpisRes.kpis);
        } catch (error) {
            setComponentError('kpiGrid', `Failed to load KPIs. ${error.message}`);
        }

        try {
            const inventoryRes = await apiCall(inventoryEndpoint);
            updateProductTableFromAPI(inventoryRes.inventory);
        } catch (error) {
            document.getElementById('productTableBody').innerHTML = `<tr><td colspan="8" class="text-center p-8"><div class="component-error">Failed to load product matrix. ${error.message}</div></td></tr>`;
        }

        try {
            const summaryRes = await apiCall(summaryEndpoint);
            updateDetailedSummary(summaryRes, cityName);
        } catch (error) {
            setComponentError('summaryKpiGrid', `Failed to load summary KPIs. ${error.message}`);
            document.getElementById('southRegionSummaryTableBody').innerHTML = `<tr><td colspan="11" class="text-center p-8"><div class="component-error">Failed to load summary details. ${error.message}</div></td></tr>`;
        }

        try {
            const alertsRes = await apiCall('/sales/alerts');
            buildAlertsFromAPI(alertsRes.alerts);
        } catch (error) {
            setComponentError('alertsPanel', `Failed to load alerts. ${error.message}`);
        }
    }
    
    function updateKPIsFromAPI(kpisData) {
        const kpiGrid = document.getElementById('kpiGrid');
        kpiGrid.innerHTML = '';
        const kpis = [
            { t: 'Availability', v: `${kpisData.availability_percentage}%`, i: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01' },
            { t: 'Plan Achievement', v: `${kpisData.plan_achievement_percentage}%`, i: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7l-4-4H7L3 7z' },
            { t: 'Available Stock', v: kpisData.available_stock.toLocaleString(), i: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7l8 5 8-5' },
            { t: 'Inventory Value', v: `₹${kpisData.inventory_value_cr} Cr`, i: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' }
        ];
        kpis.forEach(k => {
            const c = document.createElement('div');
            c.className = 'kpi-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 flex items-start gap-4';
            c.innerHTML = `<div class="p-3 bg-slate-700/50 rounded-lg"><svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${k.i}"></path></svg></div><div><p class="text-sm text-slate-400">${k.t}</p><p class="text-2xl font-bold text-white">${k.v}</p></div>`;
            kpiGrid.appendChild(c);
        });
        animateCards();
    }

    function updateProductTableFromAPI(inventoryData) {
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
        if (!inventoryData || inventoryData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-400">No product data available for this selection.</td></tr>`;
            return;
        }
        let totals = { op_stock: 0, avl_stock: 0, transit: 0, billing: 0, month_plan: 0 };
        inventoryData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-800 hover:bg-slate-800';
            const techBadge = item.technology === 'Inverter' ? 'model-inverter' : 'model-non-inverter';
            const avail = item.availability_percentage || 0;
            let sClass, sText, aColor;
            if (avail >= 150) { sClass = 'status-optimal'; sText = 'EXCELLENT'; aColor = 'text-green-400'; }
            else if (avail >= 100) { sClass = 'status-good'; sText = 'GOOD'; aColor = 'text-blue-400'; }
            else if (avail > 0) { sClass = 'status-excess'; sText = 'LOW'; aColor = 'text-orange-400'; }
            else { sClass = 'status-critical'; sText = 'CRITICAL'; aColor = 'text-red-400'; }
            const opStock = item.op_stock || item.total_op_stock || 0;
            const avlStock = item.avl_stock || item.total_avl_stock || 0;
            const transit = item.transit || item.total_transit || 0;
            const billing = item.billing || item.total_billing || 0;
            const monthPlan = item.month_plan || item.total_month_plan || 0;
            row.innerHTML = `<td class="px-4 py-3 font-medium text-white"><div class="flex items-center gap-3"><span class="px-2 py-1 text-xs rounded-full ${techBadge} text-white">${item.technology.substring(0,3)}</span><div>${item.material}<p class="text-xs text-slate-500">${item.tonnage} Tr / ${item.star} Star</p></div></div></td><td class="px-4 py-3 text-center">${parseInt(opStock).toLocaleString()}</td><td class="px-4 py-3 text-center font-semibold text-white">${parseInt(avlStock).toLocaleString()}</td><td class="px-4 py-3 text-center">${parseInt(transit).toLocaleString()}</td><td class="px-4 py-3 text-center">${parseInt(billing).toLocaleString()}</td><td class="px-4 py-3 text-center">${parseInt(monthPlan).toLocaleString()}</td><td class="px-4 py-3 text-center font-semibold ${aColor}">${avail > 0 ? avail + '%' : '-'}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs rounded-full ${sClass} text-white">${sText}</span></td>`;
            tbody.appendChild(row);
            totals.op_stock += parseInt(opStock); totals.avl_stock += parseInt(avlStock); totals.transit += parseInt(transit); totals.billing += parseInt(billing); totals.month_plan += parseInt(monthPlan);
        });
        document.getElementById('totalOpStock').textContent = totals.op_stock.toLocaleString();
        document.getElementById('totalStock').textContent = totals.avl_stock.toLocaleString();
        document.getElementById('totalTransit').textContent = totals.transit.toLocaleString();
        document.getElementById('totalBilling').textContent = totals.billing.toLocaleString();
        document.getElementById('totalMonthPlan').textContent = totals.month_plan.toLocaleString();
        const avgAvailability = totals.month_plan > 0 ? Math.round((totals.avl_stock + totals.transit) / totals.month_plan * 100) : 0;
        document.getElementById('avgAvailability').textContent = `${avgAvailability}%`;
    }

    function updateDetailedSummary(data, name) {
        if (!data) return; 
        const { summary, totals } = data;
        const kpiContainer = document.getElementById('summaryKpiGrid');
        const tableBody = document.getElementById('southRegionSummaryTableBody');
        const title = document.getElementById('summaryTableTitle');

        title.textContent = `Detailed Stock & Planning Summary for ${name}`;
        kpiContainer.innerHTML = '';
        tableBody.innerHTML = '';

        if (totals) {
            Object.entries(totals).forEach(([key, value]) => {
                const card = document.createElement('div');
                card.className = 'summary-card bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center';
                card.innerHTML = `<p class="text-sm text-slate-400 capitalize">${key.replace(/_/g, ' ')}</p><p class="text-2xl font-bold text-white">${value.toLocaleString()}</p>`;
                kpiContainer.appendChild(card);
            });
        }
        
        if (summary && summary.length > 0) {
            summary.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-800 hover:bg-slate-800';
                row.innerHTML = `<td class="px-2 py-2 font-medium text-white">${item.material}</td><td class="px-2 py-2 text-center">${parseInt(item.op_stock).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.plan).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.avl_stock).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.transit).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.billing).toLocaleString()}</td><td class="px-2 py-2 text-center font-semibold text-white">${parseInt(item.total_avl).toLocaleString()}</td><td class="px-2 py-2 text-center"><span class="highlight-col highlight-red">${parseInt(item.bal_dispatch).toLocaleString()}</span></td><td class="px-2 py-2 text-center"><span class="highlight-col highlight-orange">${parseInt(item.bal_produce).toLocaleString()}</span></td><td class="px-2 py-2 text-center">${parseInt(item.excess).toLocaleString()}</td><td class="px-2 py-2 text-center font-semibold ${item.avl_percent_plan > 100 ? 'text-green-400' : 'text-red-400'}">${item.avl_percent_plan}%</td>`;
                tableBody.appendChild(row);
            });
        } else {
            tableBody.innerHTML = `<tr><td colspan="11" class="text-center p-8 text-slate-400">No summary data available for this selection.</td></tr>`;
        }
        animateCards();
    }

    function buildAlertsFromAPI(alertsData) {
        const alertsPanel = document.getElementById('alertsPanel');
        alertsPanel.innerHTML = '';
        const criticalAlerts = alertsData.critical;
        if (criticalAlerts && criticalAlerts.length > 0) {
            criticalAlerts.slice(0, 3).forEach(alert => {
                const el = document.createElement('div');
                el.className = 'flex items-start gap-3 p-3 bg-red-500/10 border border-red-500/20 rounded-lg';
                el.innerHTML = `<div class="p-1.5 bg-red-500/20 rounded-full mt-1"><svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><div><p class="font-semibold text-white">${alert.material}</p><p class="text-sm text-slate-400">Critical stock out in ${alert.branch_name}.</p></div>`;
                alertsPanel.appendChild(el);
            });
        } else {
            alertsPanel.innerHTML = `<div class="flex items-center gap-3 p-4 bg-green-500/10 border border-green-500/20 rounded-lg"><div class="p-1.5 bg-green-500/20 rounded-full"><svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><p class="text-sm text-slate-300">No critical alerts.</p></div>`;
        }
        animateCards();
    }

    async function buildHeatmap() { 
        const h = document.getElementById('heatmapGrid'); 
        try {
            const { branches } = await apiCall('/sales/branches');
            h.innerHTML = ''; 
            branches.forEach(r => { 
                const c = document.createElement('div'); 
                c.className = 'heat-cell p-4 rounded-lg text-center cursor-pointer transition-all duration-300 bg-slate-800 hover:bg-slate-700'; 
                c.setAttribute('data-city', r.name); 
                c.innerHTML = `<p class="font-bold text-white text-lg">${r.penetration}%</p><p class="text-sm text-slate-400">${r.name}</p>`; 
                c.onclick = () => displayCityView(r.name); 
                h.appendChild(c); 
            }); 
        } catch (error) {
            setComponentError('heatmapGrid', `Failed to load branches. ${error.message}`);
        }
    }
    
    async function buildBillingVelocityPage() {
        setComponentLoading('billingVelocityTableBody');
        try {
            const response = await apiCall('/analytics/planning-analysis');
            const { planningData } = response;
            const tableBody = document.getElementById('billingVelocityTableBody');
            tableBody.innerHTML = '';
            
            if (!planningData || planningData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-400">No billing velocity data available.</td></tr>`;
                return;
            }

            planningData.sort((a, b) => b.billing_velocity - a.billing_velocity);

            planningData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-800 hover:bg-slate-800';
                const velocity = parseFloat(item.billing_velocity).toFixed(1);
                let statusClass = '';
                let statusText = '';

                if (velocity >= 100) {
                    statusClass = 'bg-green-500/20 text-green-400';
                    statusText = 'On Track';
                } else if (velocity >= 75) {
                    statusClass = 'bg-yellow-500/20 text-yellow-400';
                    statusText = 'Needs Attention';
                } else {
                    statusClass = 'bg-red-500/20 text-red-400';
                    statusText = 'Critical';
                }

                row.innerHTML = `
                    <td class="px-2 py-3 font-medium text-white">${item.branch_name}</td>
                    <td class="px-2 py-3 text-center">${parseInt(item.plan).toLocaleString()}</td>
                    <td class="px-2 py-3 text-center">${parseInt(item.billing).toLocaleString()}</td>
                    <td class="px-2 py-3 text-center">${parseInt(item.balance_to_bill).toLocaleString()}</td>
                    <td class="px-2 py-3 text-center font-semibold text-indigo-400">${velocity}%</td>
                    <td class="px-2 py-3 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            const tableBody = document.getElementById('billingVelocityTableBody');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8"><div class="component-error">Failed to load billing velocity data. ${error.message}</div></td></tr>`;
        }
    }

    async function buildSouthCoverageView() {
        try {
            const response = await apiCall('/sales/coverage-analysis');
            const { branches, summary } = response;
            document.getElementById('southTotalSales').textContent = summary.totalSales.toLocaleString();
            document.getElementById('southAvgPenetration').textContent = `${summary.avgPenetration}%`;
            document.getElementById('southTopPerformer').textContent = summary.topPerformer;
            const salesData = branches.map(b => ({ branch: b.branch_name, sales: parseInt(b.total_sales) || 0 }));
            createChart('southCoverageChart', 'bar', { labels: salesData.map(d => d.branch), datasets: [{ label: 'Sales Volume', data: salesData.map(d => d.sales), backgroundColor: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'] }] }, { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' } } } });
            createChart('southPenetrationChart', 'bar', { labels: branches.map(b => b.branch_name), datasets: [{ label: 'Sales Volume', data: branches.map(b => parseInt(b.total_sales) || 0), backgroundColor: '#4f46e5', yAxisID: 'y' }, { label: 'Penetration (%)', data: branches.map(b => parseFloat(b.penetration) || 0), backgroundColor: '#db2777', type: 'line', yAxisID: 'y1' }] }, { scales: { y: { position: 'left', grid: { color: 'rgba(255,255,255,0.05)' } }, y1: { position: 'right', grid: { drawOnChartArea: false } } } });
        } catch (error) { 
             setComponentError('southCoverageChart', `Failed to load coverage chart. ${error.message}`);
             setComponentError('southPenetrationChart', `Failed to load penetration chart. ${error.message}`);
        }
    }

    // ============================================================================
    // --- FIX: Rewritten Product Analytics Functions for Efficiency and Accuracy ---
    // ============================================================================

    async function buildModelsPage() {
        try {
            if (document.getElementById('starSelect').hasAttribute('data-listener-added')) {
                await updateModelsAnalysis();
                return;
            }

            setComponentLoading('models-analytics-container');
            const response = await apiCall('/sales/product-analytics');
            document.getElementById('models-analytics-container').innerHTML = `
                <h2 class="text-3xl font-bold text-white mb-8">Product Analytics Deep Dive</h2>
                <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div><label for="starSelect" class="block text-sm font-medium text-slate-300 mb-2">Star Rating</label><select id="starSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                    <div><label for="technologySelect" class="block text-sm font-medium text-slate-300 mb-2">Technology</label><select id="technologySelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                    <div><label for="tonnageSelect" class="block text-sm font-medium text-slate-300 mb-2">Tonnage</label><select id="tonnageSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white"></select></div>
                    <button class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg" onclick="exportModelsData()">Export Data</button>
                </div>
                <div id="modelsKpiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Tonnage</h3><div id="tonnageChartContainer" class="relative h-72"></div></div>
                            <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Star Rating</h3><div id="starRatingChartContainer" class="relative h-72"></div></div>
                        </div>
                        <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mt-6"><h3 class="text-xl font-bold text-white mb-4">Top 10 Products (by Sales Qty.)</h3><div id="topModelsChartContainer" class="relative h-80"></div></div>
                    </div>
                    <div class="lg:col-span-2">
                         <div class="chart-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 mb-6"><h3 class="text-xl font-bold text-white mb-4">Stock by Technology</h3><div id="technologyChartContainer" class="relative h-48"></div></div>
                         <div class="analytics-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 h-auto">
                            <h3 class="text-xl font-bold text-white mb-4">Dynamic Insights</h3>
                            <div id="modelInsightsContainer"><ul id="modelInsightsList" class="space-y-4 text-sm"></ul></div>
                        </div>
                    </div>
                </div>`;
            
            if (!response || !response.filters) throw new Error("Invalid response from product analytics endpoint.");
            
            const { filters } = response;

            const populate = (id, options) => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">All</option>';
                    options.forEach(option => {
                        if(option) {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            select.appendChild(opt);
                        }
                    });
                }
            };

            populate('starSelect', filters.stars);
            populate('technologySelect', filters.technologies);
            populate('tonnageSelect', filters.tonnages);

            ['starSelect', 'technologySelect', 'tonnageSelect'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('change', updateModelsAnalysis);
                el.setAttribute('data-listener-added', 'true');
            });

            await updateModelsAnalysis();

        } catch (error) {
            console.error("Error building models page:", error);
            setComponentError('models-analytics-container', `Failed to load product analytics page. ${error.message}`);
        }
    }

    async function updateModelsAnalysis() {
        const loadingSpinner = `<div class="placeholder-loading h-full w-full flex items-center justify-center"><p class="text-slate-400">Loading...</p></div>`;
        const kpiGrid = document.getElementById('modelsKpiGrid');
        const containers = {
            tonnage: document.getElementById('tonnageChartContainer'),
            star: document.getElementById('starRatingChartContainer'),
            topModels: document.getElementById('topModelsChartContainer'),
            technology: document.getElementById('technologyChartContainer'),
            insights: document.getElementById('modelInsightsContainer')
        };
        
        if (kpiGrid) kpiGrid.innerHTML = loadingSpinner.replace('h-full', 'h-24');
        Object.values(containers).forEach(c => { if(c) c.innerHTML = loadingSpinner; });

        try {
            const star = document.getElementById('starSelect').value;
            const technology = document.getElementById('technologySelect').value;
            const tonnage = document.getElementById('tonnageSelect').value;
            
            const params = new URLSearchParams({ star, technology, tonnage }).toString();
            const response = await apiCall(`/sales/product-analytics?${params}`);
            const products = response.products || [];
            
            filteredProductsForExport = products;

            // Update KPIs
            kpiGrid.innerHTML = '';
            const totalSales = products.reduce((sum, p) => sum + (Number(p.total_sales) || 0), 0);
            const totalStock = products.reduce((sum, p) => sum + (Number(p.total_stock) || 0), 0);
            const kpis = [
                { t: 'Products in Filter', v: products.length, i: 'M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 0v11a2 2 0 002 2h5a2 2 0 002-2V5a2 2 0 00-2-2H7z' },
                { t: 'Total Sales Qty.', v: totalSales.toLocaleString(), i: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7l8 5 8-5' },
                { t: 'Total Stock', v: totalStock.toLocaleString(), i: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' }
            ];
            kpis.forEach(k => {
                const card = document.createElement('div');
                card.className = 'summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-4 flex items-start gap-4';
                card.innerHTML = `<div class="p-2 bg-slate-700/50 rounded-lg"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${k.i}"></path></svg></div><div><p class="text-xs text-slate-400">${k.t}</p><p class="text-lg font-bold text-white">${k.v}</p></div>`;
                kpiGrid.appendChild(card);
            });

            // Restore canvas elements
            Object.entries(containers).forEach(([key, c]) => {
                if (c) c.innerHTML = key === 'insights' ? `<ul id="modelInsightsList" class="space-y-4 text-sm"></ul>` : `<canvas id="${key}Chart"></canvas>`;
            });

            const aggregateData = (key) => {
                const map = new Map();
                products.forEach(p => {
                    let category = p[key];
                    if (key === 'technology' && category === 'H&C Inv') category = 'Inverter';
                    if (!map.has(category)) map.set(category, { total_stock: 0 });
                    map.get(category).total_stock += Number(p.total_stock) || 0;
                });
                return Array.from(map.entries()).map(([category, data]) => ({ category, total_stock: data.total_stock }));
            };

            createChart('technologyChart', 'bar', { labels: aggregateData('technology').map(d => d.category), datasets: [{ data: aggregateData('technology').map(d => d.total_stock), backgroundColor: ['#16a34a', '#2563eb', '#ca8a04'] }] }, { indexAxis: 'y', plugins: { legend: { display: false } } });
            createChart('starRatingChart', 'bar', { labels: aggregateData('star').map(d => d.category), datasets: [{ data: aggregateData('star').map(d => d.total_stock), backgroundColor: '#4f46e5' }] }, { indexAxis: 'y', plugins: { legend: { display: false } } });
            createChart('tonnageChart', 'polarArea', { labels: aggregateData('tonnage').map(d => d.category), datasets: [{ data: aggregateData('tonnage').map(d => d.total_stock), backgroundColor: ['#db2777', '#f97316', '#16a34a', '#2563eb', '#7c3aed', '#ca8a04'] }] });
            const topModels = [...products].sort((a, b) => (Number(b.total_sales) || 0) - (Number(a.total_sales) || 0)).slice(0, 10);
            createChart('topModelsChart', 'bar', { labels: topModels.map(p => p.material), datasets: [{ label: 'Sales Qty.', data: topModels.map(p => p.total_sales), backgroundColor: '#f97316' }] }, { indexAxis: 'y' });
            
            animateCards();
        } catch (error) {
            console.error("Error updating models analysis:", error);
            setComponentError('modelsKpiGrid', `Failed to update analysis. ${error.message}`);
        }
    }


    async function buildPlanningPage() {
        try {
            const response = await apiCall('/analytics/planning-analysis');
            const { planningData, insights } = response;
            const tableBody = document.getElementById('branchPlanningTableBody');
            const narrativeEl = document.getElementById('planningNarrative');
            const decisionsEl = document.getElementById('planningDecisions');
            tableBody.innerHTML = '';
            planningData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-700 font-semibold';
                row.innerHTML = `<td class="px-2 py-2 text-white">${item.branch_name}</td><td class="px-2 py-2 text-center">${parseInt(item.op_stock).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.plan).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.avl_stock).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.transit).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.billing).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.balance_to_bill).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.total_availability).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.balance_to_dispatch).toLocaleString()}</td><td class="px-2 py-2 text-center">${parseInt(item.excess_stock).toLocaleString()}</td><td class="px-2 py-2 text-center text-indigo-400">${parseFloat(item.billing_velocity).toFixed(1)}%</td>`;
                tableBody.appendChild(row);
            });
            narrativeEl.innerHTML = `<h3 class="text-xl font-bold text-white mb-3">Planning Overview</h3><p class="text-slate-300 leading-relaxed">The planning vs. actuals data reveals key operational insights. <span class="data-point">${insights.topPerformer.branch_name}</span> shows the highest efficiency with a billing velocity of <span class="data-point">${parseFloat(insights.topPerformer.billing_velocity).toFixed(1)}%</span>. Conversely, <span class="data-point">${insights.biggestSupplyGap.branch_name}</span> faces the largest supply gap, requiring an additional <span class="data-point">${parseInt(insights.biggestSupplyGap.balance_to_dispatch).toLocaleString()}</span> units to meet its plan. There is also an opportunity for inventory optimization, as <span class="data-point">${insights.mostExcessStock.branch_name}</span> holds the largest excess stock.</p>`;
            const recommendationsResponse = await apiCall('/analytics/recommendations');
            const { recommendations } = recommendationsResponse;
            decisionsEl.innerHTML = recommendations.map((rec, index) => `<div class="decision-card" style="animation-delay: ${(index + 1) * 100}ms;"><h4><svg class="w-6 h-6 text-${rec.priority === 'high' ? 'red' : rec.priority === 'medium' ? 'yellow' : 'green'}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>${rec.title}</h4><p>${rec.description}</p></div>`).join('');
        } catch (error) { 
            setComponentError('planningContent', `Failed to load planning page. ${error.message}`);
        }
    }

    async function buildAnalyticsSummary() {
        await buildExecutiveOverview();
        await buildDataDeepDive();
        await buildPerformanceTrends();
        setupAnalyticsSubNav();
    }

    function setupAnalyticsSubNav() {
        const navItems = document.querySelectorAll('.analytics-sub-nav-item');
        const pages = document.querySelectorAll('.analytics-page');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const pageId = `analyticsPage-${item.dataset.page}`;
                pages.forEach(p => p.style.display = 'none');
                document.getElementById(pageId).style.display = 'block';
                animateCards();
            });
        });
    }

    async function buildExecutiveOverview() {
        try {
            const [summaryResponse, recommendationsResponse] = await Promise.all([apiCall('/analytics/executive-summary'), apiCall('/analytics/recommendations')]);
            const { summary } = summaryResponse;
            const { recommendations } = recommendationsResponse;
            const narrativeEl = document.getElementById('executiveSummaryNarrative');
            const decisionsEl = document.getElementById('actionableDecisions');
            const kpiGrid = document.getElementById('analyticsKpiGrid');
            const invPercentage = summary.technologyBreakdown.find(t => t.technology === 'Inverter')?.percentage || 0;
            narrativeEl.innerHTML = `The South Region is showing steady performance, achieving <span class="font-bold text-white">${summary.planAchievement}%</span> of its sales plan. Growth is primarily driven by <span class="font-bold text-green-400">Inverter technology models</span>, which constitute ${invPercentage}% of total sales. The best-selling product is <span class="font-bold text-white">${summary.bestSellingProduct.material}</span> with <span class="font-bold text-white">${parseInt(summary.bestSellingProduct.total_sales).toLocaleString()}</span> units sold.`;
            decisionsEl.innerHTML = recommendations.map((rec, index) => `<div class="decision-card" style="animation-delay: ${(index + 1) * 100}ms;"><h4><svg class="w-6 h-6 text-${rec.priority === 'high' ? 'red' : 'yellow'}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>${rec.title}</h4><p>${rec.description}</p></div>`).join('');
            const kpis = [
                { t: 'Total Regional Sales', v: `${summary.totalSales.toLocaleString()} Units`, i: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' }, { t: 'Overall Plan Achievement', v: `${summary.planAchievement}%`, i: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7l-4-4H7L3 7z' },
                { t: 'Best Selling Model', v: summary.bestSellingProduct.material, i: 'M5 15l7-7 7 7' }, { t: 'Total Products', v: summary.productCount, i: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m5-4h1m-1 4h1m-1-4h1m-1 4h1' }
            ];
            kpiGrid.innerHTML = kpis.map(k => `<div class="summary-card bg-slate-800/50 border border-slate-700 rounded-2xl p-6 flex items-start gap-4"><div class="p-3 bg-slate-700/50 rounded-lg"><svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${k.i}"></path></svg></div><div><p class="text-sm text-slate-400">${k.t}</p><p class="text-xl font-bold text-white">${k.v}</p></div></div>`).join('');
        } catch (error) { setComponentError('analyticsPage-overview', `Failed to load executive overview. ${error.message}`); }
    }

    async function buildDataDeepDive() {
        try {
            const response = await apiCall('/analytics/product-performance');
            const { topPerformers, bottomPerformers } = response;
            const topBody = document.getElementById('top10ModelsBody');
            const bottomBody = document.getElementById('bottom10ModelsBody');
            const narrativeEl = document.getElementById('deepDiveNarrative');
            narrativeEl.innerHTML = `<h3 class="text-xl font-bold text-white mb-3">Data Analysis</h3><p class="text-slate-300 leading-relaxed">This detailed view breaks down performance by individual products and branches. The top-performing models list highlights market leaders and key revenue drivers. In contrast, the bottom-performers list identifies products that may require marketing support or potential phasing out.</p>`;
            const populateTable = (tbody, data) => { tbody.innerHTML = data.map(model => `<tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="px-4 py-2 font-medium text-white">${model.material}</td><td class="px-4 py-2 text-center">${parseInt(model.total_sales).toLocaleString()}</td><td class="px-4 py-2 text-center font-semibold ${parseFloat(model.plan_achievement) > 80 ? 'text-green-400' : 'text-orange-400'}">${parseFloat(model.plan_achievement).toFixed(1)}%</td></tr>`).join(''); };
            populateTable(topBody, topPerformers);
            populateTable(bottomBody, bottomPerformers);
            const branchResponse = await apiCall('/analytics/branch-performance');
            const branchData = branchResponse.branchPerformance;
            createChart('regionalSalesVsPlanChart', 'bar', { labels: branchData.map(b => b.branch_name), datasets: [{ label: 'Sales Plan', data: branchData.map(b => parseInt(b.total_plan) || 0), backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: '#4f46e5', borderWidth: 1 }, { label: 'Actual Sales', data: branchData.map(b => parseInt(b.total_sales) || 0), backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: '#22c55e', borderWidth: 1 }] }, { scales: { y: { beginAtZero: true } } });
            createChart('regionalStockVsTransitChart', 'bar', { labels: branchData.map(b => b.branch_name), datasets: [{ label: 'Available Stock', data: branchData.map(b => parseInt(b.total_stock) || 0), backgroundColor: '#3b82f6' }, { label: 'In Transit', data: branchData.map(b => parseInt(b.total_transit) || 0), backgroundColor: '#f97316' }] }, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } });
        } catch (error) { setComponentError('analyticsPage-deepdive', `Failed to load data deep dive. ${error.message}`); }
    }

    async function buildPerformanceTrends() {
        try {
            const response = await apiCall('/analytics/trends/monthly');
            const { trends } = response;
            const narrativeEl = document.getElementById('trendsNarrative');
            narrativeEl.innerHTML = `<h3 class="text-xl font-bold text-white mb-3">Trend Insights</h3><p class="text-slate-300 leading-relaxed mb-4">The 6-month performance trend shows a positive growth trajectory. Sales have consistently increased, surpassing the initial plan in recent months, which indicates strong market demand and effective sales execution.</p><p class="text-slate-300 leading-relaxed">However, the stock level trend requires attention. While efficient inventory turnover is positive, monitoring is crucial to prevent stockouts as sales continue to rise. Consider proactive inventory planning to sustain current sales momentum.</p>`;
            createChart('monthlyTrendsChart', 'line', { labels: trends.map(t => t.period), datasets: [{ label: 'Sales', data: trends.map(t => t.sales), borderColor: '#22c55e', tension: 0.3, yAxisID: 'y' }, { label: 'Plan', data: trends.map(t => t.plan), borderColor: '#4f46e5', tension: 0.3, yAxisID: 'y' }, { label: 'Stock Level', data: trends.map(t => t.stock), borderColor: '#f97316', tension: 0.3, yAxisID: 'y1', borderDash: [5, 5] }] }, { scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Units (Sales/Plan)' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Units (Stock)' }, grid: { drawOnChartArea: false } } } });
        } catch (error) { setComponentError('analyticsPage-trends', `Failed to load performance trends. ${error.message}`); }
    }
    
    // --- Chart Helper ---
    function createChart(id, type, data, options = {}) {
        const ctx = document.getElementById(id); if (!ctx) return;
        if (chartInstances[id]) chartInstances[id].destroy();
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
            scales: { x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } } }
        };
        chartInstances[id] = new Chart(ctx, { type, data, options: { ...defaultOptions, ...options, plugins: {...defaultOptions.plugins, ...options.plugins}, scales: {...defaultOptions.scales, ...options.scales} } });
    }

    // --- CHATBOT LOGIC ---
    function initializeChatbot() {
        const toggleButton = document.getElementById('chatbot-toggle');
        const chatWindow = document.getElementById('chatbot-window');
        const sendButton = document.getElementById('chatbot-send');
        const input = document.getElementById('chatbot-input');
        const messagesContainer = document.getElementById('chatbot-messages');
        
        toggleButton.addEventListener('click', () => { 
            const isHidden = chatWindow.style.display === 'none' || chatWindow.style.display === ''; 
            chatWindow.style.display = isHidden ? 'flex' : 'none'; 
            if (isHidden && messagesContainer.children.length === 0) { 
                addMessage("Hello! I'm the Hansei AI assistant. How can I help you with the sales data today?", 'bot'); 
            } 
        });
        
        const handleSendMessage = async () => { 
            const userMessage = input.value.trim(); 
            if (userMessage) { 
                addMessage(userMessage, 'user'); 
                input.value = ''; 
                try {
                    const botResponse = await getBotResponse(userMessage); 
                    addMessage(botResponse, 'bot');
                } catch (error) {
                    addMessage("Sorry, I'm having trouble connecting. Please try again later.", 'bot');
                }
            } 
        };
        
        sendButton.addEventListener('click', handleSendMessage);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSendMessage(); });
        
        function addMessage(text, sender) { 
            const messageElement = document.createElement('div'); 
            messageElement.className = `chat-message ${sender}-message`; 
            messageElement.textContent = text; 
            messagesContainer.appendChild(messageElement); 
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }
        
        async function getBotResponse(userInput) {
            const response = await apiCall('/chatbot/query', {
                method: 'POST',
                body: JSON.stringify({ message: userInput })
            });
            return response.response;
        }
    }

    // --- BACKEND HEALTH CHECK ---
    async function checkBackendHealth() {
        try {
            updateConnectionStatus('connecting', 'Connecting to Backend...');
            const response = await fetch(`${API_BASE_URL}/health`, {
                signal: AbortSignal.timeout(10000) // 10 second timeout for health check
            });
            if (response.ok) {
                console.log('✅ Backend is connected.');
                updateConnectionStatus('connected', 'Backend Connected');
            } else {
                console.error('❌ Backend connection failed. Status:', response.status);
                updateConnectionStatus('disconnected', 'Backend Unavailable');
            }
        } catch (error) {
            console.error('❌ Backend connection failed. Error:', error);
            updateConnectionStatus('disconnected', 'Connection Failed');
        }
    }

    // --- APP INITIALIZATION ---
    window.addEventListener('load', () => {
        localStorage.clear();
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        showNotification('Hansei Platform Ready. Please log in.', 'success');
        
        // Check backend health on startup
        checkBackendHealth();
    });
    
    // --- GLOBAL FUNCTIONS ---
    window.doLogin = doLogin; 
    window.togglePassword = togglePassword; 
    window.secureLogout = secureLogout; 
    window.displayCityView = displayCityView; 
    
    function exportModelsData() {
        if (filteredProductsForExport.length === 0) {
            showNotification('No data to export for the current filter.', 'error');
            return;
        }
        const ws = XLSX.utils.json_to_sheet(filteredProductsForExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ProductAnalytics");
        XLSX.writeFile(wb, "Hansei_Product_Analytics_Export.xlsx");
        showNotification('Data exported successfully!', 'success');
    }
    window.exportModelsData = exportModelsData;

    </script>
   	
</body>
</html>
